<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nbcb.myron.bsen.dao.BsenDao">

    <!--开启二级缓存-->
    <!--<cache type="com.nbcb.myron.bsen.common.RedisCache"></cache>-->
    <!--获得http ip-->
    <select id="getHttpAddress" resultType="com.nbcb.myron.bsen.module.DictEntity">
        select i.dictname ip from dictionary i where i.dicttypeid = #{dicttypeid} and i.dictid = #{dictid};
    </select>

    <!--获取首页商品头部轮播图-->
    <select id="getImageEntityList" resultType="com.nbcb.myron.bsen.module.ImageEntity">
      SELECT i.pid id,i.t_url imgPath,i.t_url_name imgName FROM products i WHERE i.is_true = '0';
    </select>

    <!--砍价商品-->
    <select id="getBestCutProducts" resultType="com.nbcb.myron.bsen.module.CutProduct">
      SELECT
          i.pid  id,
          i.desc,
          CONCAT(j.path,j.filename) imgUrl,
          i.price oldPrice,
          i.cutting_num cutPriceNum,
          i.cuted_price newPrice
        FROM products i
        LEFT JOIN products_files j ON i.pid = j.pid
        WHERE i.is_cut = '0' AND j.classify ='2'AND i.cutting_num > 50;
    </select>

    <!--精品-->
    <select id="getBoutiqueProducts" resultType="com.nbcb.myron.bsen.module.BoutiqueProduct">
        SELECT
          i.pid id,
          CONCAT(j.path,j.filename) imgUrl,
          i.desc,
          i.price oldPrice,
          i.cuted_price newPrice
        FROM products i
          LEFT JOIN products_files j
            ON i.pid = j.pid
        WHERE j.classify = '0'
            AND i.is_boutique = '0'
        GROUP BY i.pid;
    </select>

    <!--全部分类商品-->
    <select id="getProductLists" resultType="com.nbcb.myron.bsen.module.ProductListEntity">
        SELECT
        i.pid id,
        i.desc,
        i.price oldPrice,
        i.cuted_price newPrice,
        i.soldnum soldNum,
        i.browsenum browseNum,
        CONCAT(j.path,j.filename) imgUrl
        FROM products i
        LEFT JOIN products_files j ON i.pid = j.pid
        WHERE j.classify='2'
        <if test="classifyId !=  '00'">AND i.classify =#{classifyId}</if>
    </select>

    <!--全部分类商品按价格排序-升-->
    <select id="getProductListsJgS" resultType="com.nbcb.myron.bsen.module.ProductListEntity">
        SELECT
        i.pid id,
        i.desc,
        i.price oldPrice,
        i.cuted_price newPrice,
        i.soldnum soldNum,
        i.browsenum browseNum,
        CONCAT(j.path,j.filename) imgUrl
        FROM products i
        LEFT JOIN products_files j ON i.pid = j.pid
        WHERE j.classify='2'
        <if test="classifyId !=  '00'">AND i.classify =#{classifyId}</if>
        GROUP BY i.price ASC;
    </select>

    <!--全部分类商品按价格排序-降-->
    <select id="getProductListsJgJ" resultType="com.nbcb.myron.bsen.module.ProductListEntity">
        SELECT
        i.pid id,
        i.desc,
        i.price oldPrice,
        i.cuted_price newPrice,
        i.soldnum soldNum,
        i.browsenum browseNum,
        CONCAT(j.path,j.filename) imgUrl
        FROM products i
        LEFT JOIN products_files j ON i.pid = j.pid
        WHERE j.classify='2'
        <if test="classifyId !=  '00'">AND i.classify =#{classifyId}</if>
        GROUP BY i.price DESC;
    </select>

    <!--获取商品详情-->
    <select id="getDetail" resultMap="SwipeImgs">
      SELECT
          i.pid,
          i.price,
          i.cuted_price,
          i.desc,
          i.soldnum,
          i.browsenum
        FROM products i
        WHERE i.pid = #{id};
    </select>

    <!--查询对当前商品点赞的所有人员-->
    <select id="selectParsePsersons" resultType="com.nbcb.myron.bsen.module.User">
        SELECT
        i.path avatarUrl
        FROM users i
        LEFT JOIN users_products j
        ON i.uid = j.uid
        LEFT JOIN products k
        ON j.pid = k.pid
        WHERE j.pid =#{id}
        <if test="userId != null and userId !=''">AND j.uid=#{userId}</if>
        AND j.isdz =1;
    </select>

    <!--查询对当前商品点过赞的人员头像-->
    <select id="selectDz" resultType="com.nbcb.myron.bsen.module.UserProduct">
      SELECT j.id,j.pid,j.uid,j.isdz FROM users_products j WHERE j.pid =#{id} AND j.uid =#{userId};
    </select>

    <!--详情插入赞-->
    <insert id="insertDz">
        INSERT INTO bsen_door_dev.users_products (pid,uid)
        VALUES(#{id},#{userId})
    </insert>

    <!--详情更新添加赞-->
    <update id="updateDzP" flushCache="true">
        UPDATE users_products i
        SET i.isdz = i.isdz + 1
        where i.pid =#{id}
        AND i.uid=#{userId}
    </update>

    <!--详情取消赞-->
    <update id="updateDzM" flushCache="true">
        UPDATE users_products i
        SET i.isdz = i.isdz - 1
        where i.pid =#{id}
        AND i.uid=#{userId}
    </update>

    <resultMap type="com.nbcb.myron.bsen.module.Product" id="SwipeImgs">
        <id property="id" column="pid"/>
        <result property="oldPrice" column="price"/>
        <result property="newPrice" column="cuted_price"/>
        <result property="desc" column="desc"/>
        <result property="soldNum" column="soldnum"/>
        <result property="browseNum" column="browsenum"/>
        <collection property="imgUrls" ofType="com.nbcb.myron.bsen.module.ProductImg" column="{bridgeId1=pid}"
                    select="getDetailImg1"></collection>
        <collection property="detailImgUrls" ofType="com.nbcb.myron.bsen.module.ProductImg" column="{bridgeId2=pid}"
                    select="getDetailImg2"></collection>
        <collection property="evaluates" ofType="com.nbcb.myron.bsen.module.User" column="{bridgeId3=pid}"
                    select="getEvaluates"></collection>
    </resultMap>

    <!--获取商品详情轮播图-->
    <select id="getDetailImg1" resultType="com.nbcb.myron.bsen.module.ProductImg">
      SELECT
          i.path,
          i.filename
        FROM products_files i
        WHERE i.pid = #{bridgeId1}
        AND i.classify = '0';
    </select>

    <!--获取商品详情图-->
    <select id="getDetailImg2" resultType="com.nbcb.myron.bsen.module.ProductImg">
      SELECT
          i.path,
          i.filename
        FROM products_files i
        WHERE i.pid = #{bridgeId2}
        AND i.classify = '1';
    </select>

    <!--获取商品评论-->
    <select id="getEvaluates" resultType="com.nbcb.myron.bsen.module.User">
      SELECT
          i.turn_over turnover,
          i.evaluate,
          FROM_UNIXTIME(i.time/1000,'%Y-%m-%d %H:%i:%s') time,
          j.uid,
          j.nickname
        FROM orders i
        LEFT JOIN users j ON i.user_id = j.uid
        WHERE i.i_id = #{bridgeId3}
    </select>

    <!--所有砍价商品-->
    <select id="getCutProductsList" resultType="com.nbcb.myron.bsen.module.CutProduct">
      SELECT
          i.pid            id,
          i.desc,
          CONCAT(j.path,j.filename)    imgUrl,
          i.price          oldPrice,
          i.cuted_price    newPrice,
          i.soldnum    soldNum,
          i.browsenum browseNum
        FROM products i
          LEFT JOIN products_files j
            ON i.pid = j.pid
        WHERE i.is_cut = '0'
            AND j.classify = '2'
    </select>

    <!--搜索商品-->
    <select id="getSearchProducts" resultType="com.nbcb.myron.bsen.module.ProductListEntity">
        SELECT
        i.pid id,
        i.desc,
        i.price oldPrice,
        i.cuted_price newPrice,
        i.soldnum soldNum,
        i.browsenum browseNum,
        CONCAT(j.path,j.filename) imgUrl
        FROM products i
        LEFT JOIN products_files j ON i.pid = j.pid
        WHERE j.classify='2'
        <if test="keyWord != null and keyWord !=''">AND i.desc like concat('%',#{keyWord},'%')</if>
        GROUP BY i.pid;
    </select>

    <!--查询动态-->
    <select id="getDynamics" resultMap="DynamicMap">
       SELECT
        i.id id,
        i.userid uId,
        i.concent content,
        i.likenum likeNum,
        i.browsenum browseNum,
        FROM_UNIXTIME(i.time/1000,'%Y-%m-%d %H:%i:%s') releaseTime,
        j.nickname nickName,
        CONCAT(j.path,j.filename) headImgUrl
        FROM
        (
        SELECT * FROM users_dynamic m WHERE m.userid='oM78247bYUgo2bsq8ZUEAf_d-GLM'  ORDER BY m.time DESC
        ) i
        LEFT JOIN users j
        ON i.userid = j.uid
        LEFT JOIN products_files k
        ON i.id = k.did
        WHERE j.authority=0
        GROUP BY i.time DESC
        LIMIT #{page},#{offset};
    </select>

    <resultMap id="DynamicMap" type="com.nbcb.myron.bsen.module.Dynamic">
        <collection property="contentImgs" ofType="String" column="{bridgeId = id}" select="getContentImgs"/>
        <collection property="dynamicComments" ofType="com.nbcb.myron.bsen.module.User" column="{bridgeId1 = id}"
                    select="getDynamicComments"/>
    </resultMap>

    <select id="getContentImgs" resultType="String">
        SELECT
        CONCAT(k.path,k.filename) contentImgs
        FROM
        products_files k
        WHERE k.classify ='3'
        AND k.did = #{bridgeId};
    </select>

    <select id="getDynamicComments" resultType="com.nbcb.myron.bsen.module.User">
        SELECT
          j.uid uId,
          j.nickname nickName,
          i.content evaluate
        FROM users_dynamics_comments i
          LEFT JOIN users j
            ON i.userid = j.uid
        WHERE i.did = #{bridgeId1};
    </select>

    <insert id="addDynamicDesc" parameterType="com.nbcb.myron.bsen.module.UsersDynamic">
        INSERT INTO bsen_door_dev.users_dynamic
        (userid,
        concent,
        TIME
        )
        VALUES
        (#{userId},
        #{desc},
        #{time});
    </insert>

    <select id="selectDynamicNum" resultType="Integer">
        SELECT COUNT(*) FROM users_dynamic;
    </select>

    <insert id="addDynamicImgs" parameterType="com.nbcb.myron.bsen.module.ProductsFiles">
        INSERT INTO bsen_door_dev.products_files
        (uid,did,pid,path,filename,classify)
        VALUES
        (#{uId},#{dId},#{pId},#{path},#{fileName},#{classify});
    </insert>

    <!--查询动态详情-->
    <select id="dynamicDetail" resultMap="Product">
      SELECT
        i.id id,
        i.userid uId,
        i.concent content,
        i.likenum likeNum,
        i.browsenum browseNum,
        FROM_UNIXTIME(i.time/1000,'%Y-%m-%d %H:%i:%s') releaseTime,
        j.nickname nickName,
        CONCAT(j.path,j.filename) headImgUrl
        FROM
        (
        SELECT * FROM users_dynamic m ORDER BY m.time DESC
        ) i
        LEFT JOIN users j
        ON i.userid = j.uid
        LEFT JOIN products_files k
        ON i.id = k.did
        WHERE i.id=#{id}
        AND j.authority = 0
        GROUP BY i.time
    </select>

    <resultMap id="Product" type="com.nbcb.myron.bsen.module.Dynamic">
        <collection property="contentImgs" ofType="String" column="{bridgeId = id}" select="getContentImgs"/>
        <collection property="dynamicComments" ofType="com.nbcb.myron.bsen.module.User" column="{bridgeId1 = id}"
                    select="getDynamicComments"/>
    </resultMap>

    <update id="updateProductBrowseNum" flushCache="true">
        UPDATE products i
        SET i.browsenum = i.browsenum + 1
        <if test="id != null and id !=''">where i.pid =#{id}</if>
    </update>

    <update id="updataDynamicsBrowseNum" flushCache="true">
        UPDATE users_dynamic i
        SET i.browsenum = i.browsenum + 1
        <if test="id != null and id !=''">where i.id =#{id}</if>
    </update>

    <update id="updateUserLoginStatus" flushCache="true">
        UPDATE users i
        SET
        i.session_key = #{session_key},
        i.login_state = #{login_state},
        i.nickname = #{nickName},
        i.gender = #{gender},
        i.path = #{avatarUrl}
        where i.uid =#{uId}
    </update>

    <select id="selectUser" resultType="com.nbcb.myron.bsen.module.User">
        select
          login_state loginState,
          nickname nickName,
          gender,
          path avatarUrl,
          authority
        from users where uid = #{uId}
    </select>

    <insert id="insertNewUser">
        INSERT INTO bsen_door_dev.users
                    (uid,session_key,login_state,nickname,gender,path)
        VALUES (#{uId},#{session_key},#{login_state},#{nickName},#{gender},#{avatarUrl})
    </insert>

    <update id="updatePlus" flushCache="true">
        UPDATE users_dynamic i
        SET i.likenum = i.likenum + 1
        <if test="id != null and id !=''">where i.id =#{id}</if>
    </update>

    <update id="updateMinus" flushCache="true">
        UPDATE users_dynamic i
        SET i.likenum = i.likenum - 1
        where i.id =#{id}
    </update>

    <insert id="insertComment">
        INSERT INTO users_dynamics_comments
            (did,
             userid,
             content)
        VALUES (#{id},
        #{userId},
        #{comment})
    </insert>

    <select id="selectUserComment" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM users_dynamics_comments i WHERE i.userid=#{userId} AND i.did=#{id};
    </select>

    <select id="selectProduct" resultType="java.lang.Integer">
        SELECT
          COUNT(*)
        FROM orders i
        WHERE i.user_id =#{userId} AND i.i_id=#{pid} AND i.status='0';
    </select>

    <insert id="addProductC" parameterType="com.nbcb.myron.bsen.module.Order">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            select LAST_INSERT_ID();
        </selectKey>
        INSERT INTO orders
        (user_id,i_id,STATUS,turn_over,price,TIME)
        VALUES
        (#{userId},#{pid},#{status},#{turnOver},#{price},#{time});
    </insert>

    <insert id="addProductO" parameterType="com.nbcb.myron.bsen.module.Order">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            select LAST_INSERT_ID();
        </selectKey>
        INSERT INTO orders
        (user_id,i_id,STATUS,turn_over,price,TIME,order_num)
        VALUES
        (#{userId},#{pid},#{status},#{turnOver},#{price},#{time},#{order_num});
    </insert>

    <update id="updateProduct"  flushCache="true">
        UPDATE orders i
        SET
        i.turn_over = #{turnOver},
        i.time = #{time}
        WHERE i.user_id =#{userId} AND i.i_id=#{pid};
    </update>

    <!--更新订单信息-->
    <update id="updateOrderInfo" flushCache="true">
        UPDATE orders t
        SET
        t.status = #{status},
        t.turn_over = #{turnOver},
        t.price = #{price},
        t.time = #{time},
        t.order_num =#{order_num}
        WHERE t.user_id = #{userId}
        AND t.i_id = #{pid}
    </update>

    <select id="selectCartProductsCounts" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM orders i WHERE i.status='0' AND i.turn_over>0 AND i.user_id=#{userId} ;
    </select>

    <select id="selectDealingProduct" resultType="com.nbcb.myron.bsen.module.OrderInfo">
      SELECT
          CONCAT(k.path,k.filename) imgUrl,
          j.desc
        FROM products j
          LEFT JOIN products_files k
            ON k.pid = j.pid
        WHERE j.pid = #{pid}
        AND k.classify='2'
    </select>

    <select id="selectCartProducts" resultType="com.nbcb.myron.bsen.module.OrderInfo">
        SELECT
          i.id id,
          i.i_id pid,
          i.turn_over turnOver,
          i.price,
          concat(k.path,k.filename) imgUrl,
          j.desc
        FROM orders i
          LEFT JOIN products_files k
            ON i.i_id = k.pid
          LEFT JOIN products j
            ON k.pid = j.pid
        WHERE i.user_id = #{userId}
          AND i.id = #{id}
          AND i.i_id = #{pid}
          AND k.classify = '2'
          AND i.status = #{status}
           GROUP BY i.i_id
    </select>

    <select id="selectCartProductList" resultType="com.nbcb.myron.bsen.module.OrderInfo">
        SELECT
          i.id id,
          i.i_id pid,
          i.turn_over    turnOver,
          i.price,
          CONCAT(k.path,k.filename)    imgUrl,
          j.desc
        FROM orders i
          LEFT JOIN products_files k
            ON i.i_id = k.pid
          LEFT JOIN products j
            ON k.pid = j.pid
        WHERE i.user_id = #{userId}
            AND i.status = #{status}
            AND k.classify = '2'
            AND i.status = '0'

    </select>

    <update id="updateProductNum" flushCache="true">
        UPDATE orders
        SET turn_over = #{turnOver}
        WHERE user_id = #{userId}
            AND id = #{id}
    </update>
</mapper>
